{% extends "layout.html" %}

{% block content %}
<div class="container mt-4">
    <h1>標準勘定科目残高一覧</h1>
    
    <!-- JA選択フォーム -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="jaSelectForm" method="get" action="{{ url_for('account_balances') }}">
                <div class="row g-3 align-items-center">
                    <div class="col-auto">
                        <label for="ja_code" class="form-label">JA:</label>
                        <select class="form-select" id="ja_code" name="ja_code">
                            {% for ja in jas %}
                                <option value="{{ ja.ja_code }}" {% if ja.ja_code == selected_ja_code %}selected{% endif %}>
                                    {{ ja.name }} ({{ ja.ja_code }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-auto">
                        <label for="year" class="form-label">年度:</label>
                        <select class="form-select" id="year" name="year">
                            {% for year in years %}
                                <option value="{{ year }}" {% if year|int == selected_year|int %}selected{% endif %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-auto">
                        <label for="financial_statement" class="form-label">財務諸表:</label>
                        <select class="form-select" id="financial_statement" name="financial_statement">
                            <option value="bs" {% if financial_statement == 'bs' %}selected{% endif %}>貸借対照表 (BS)</option>
                            <option value="pl" {% if financial_statement == 'pl' %}selected{% endif %}>損益計算書 (PL)</option>
                            <option value="cf" {% if financial_statement == 'cf' %}selected{% endif %}>キャッシュフロー計算書 (CF)</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-flex">
                            <div class="form-check me-3 mt-2">
                                <input class="form-check-input" type="checkbox" id="recreate_balances" name="recreate_balances" value="true" checked>
                                <label class="form-check-label" for="recreate_balances">残高再計算</label>
                            </div>
                            <button type="submit" class="btn btn-primary">表示</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 標準科目残高テーブル -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">標準勘定科目残高一覧 ({{ financial_statement | upper }})</h5>
            <div>
                <button class="btn btn-sm btn-success me-2" id="calculateTotalsButton">科目合計計算</button>
                <button class="btn btn-sm btn-danger me-2" id="recreateBalancesButton">残高データ再作成</button>
                <button class="btn btn-sm btn-secondary" id="refreshButton">最新情報に更新</button>
            </div>
        </div>
        <div class="card-body">
            {% if balances %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sm">
                        <thead>
                            <tr class="align-middle">
                                <th class="py-1">コード</th>
                                <th class="py-1">標準勘定科目名</th>
                                <th class="py-1">上位科目コード</th>
                                <th class="py-1">科目タイプ</th>
                                <th class="text-end py-1">当期残高</th>
                                <th class="text-end py-1">前期残高</th>
                                <th class="text-end py-1">増減</th>
                                <th class="text-end py-1">増減率(%)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for balance in balances %}
                            {% set is_total_account = balance.standard_account_code in ['2900', '4900', '5900', '5950', '5951'] %}
                            <tr data-code="{{ balance.standard_account_code }}" class="{% if balance.parent_code is none %}fw-bold{% endif %} align-middle py-0 {% if is_total_account %}total-account-row{% endif %}">
                                <td class="py-1">{{ balance.standard_account_code|safe_int }}</td>
                                <td class="py-1">
                                    {% if balance.is_child %}
                                    <span style="padding-left: 20px; position: relative;">
                                        <span style="position: absolute; left: 5px; top: 50%; transform: translateY(-50%);">└</span>
                                        {{ balance.standard_account_name }}
                                    </span>
                                    {% else %}
                                    {{ balance.standard_account_name }}
                                    {% endif %}
                                </td>
                                <td class="py-1">{{ balance.parent_code|safe_int }}</td>
                                <td class="py-1">{{ balance.statement_subtype }}</td>
                                <td class="text-end py-1">{{ '{:,.0f}'.format(balance.current_value) if balance.current_value is not none else '-' }}</td>
                                <td class="text-end py-1">{{ '{:,.0f}'.format(balance.previous_value) if balance.previous_value is not none else '-' }}</td>
                                <td class="text-end py-1">
                                    {% if balance.current_value is not none and balance.previous_value is not none %}
                                        {{ '{:,.0f}'.format(balance.current_value - balance.previous_value) }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="text-end py-1">
                                    {% if balance.current_value is not none and balance.previous_value is not none and balance.previous_value != 0 %}
                                        {{ '{:.2f}'.format((balance.current_value - balance.previous_value) / balance.previous_value * 100) }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if not balances %}
                <div class="alert alert-info">
                    残高データがありません。まずはCSVデータをインポートし、マッピングを完了させてください。
                </div>
                {% endif %}
            {% else %}
                <div class="alert alert-info">
                    データがありません。JA、年度、財務諸表を選択し、「表示」ボタンをクリックしてください。
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // 最新情報に更新ボタンのクリックイベント
    $('#refreshButton').click(function() {
        var currentUrl = window.location.href;
        var refreshUrl = currentUrl + (currentUrl.includes('?') ? '&' : '?') + 'refresh=true';
        window.location.href = refreshUrl;
    });
    
    // 科目合計計算ボタンのクリックイベント
    $('#calculateTotalsButton').click(function() {
        if (confirm('勘定科目の合計を計算します。よろしいですか？\n※既存の計算結果は上書きされます。')) {
            var currentUrl = window.location.href;
            var calculateUrl = currentUrl + (currentUrl.includes('?') ? '&' : '?') + 'calculate_totals=true';
            window.location.href = calculateUrl;
        }
    });
    
    // 残高データ再作成ボタンのクリックイベント
    $('#recreateBalancesButton').click(function() {
        if (confirm('残高データを再作成します。よろしいですか？\n※既存の残高データは削除され、CSVデータとマッピング情報から再作成されます。')) {
            var currentUrl = window.location.href;
            var recreateUrl = currentUrl + (currentUrl.includes('?') ? '&' : '?') + 'recreate_balances=true';
            window.location.href = recreateUrl;
        }
    });

    // JA、年度、財務諸表が変更されたら自動的にフォームを送信
    $('#ja_code, #year, #financial_statement').change(function() {
        $('#jaSelectForm').submit();
    });
    
    // 合計科目コードセット（パフォーマンス向上のため事前に定義）
    var totalAccountCodes = {
        // BS合計科目
        '2900': true, '4900': true, '5900': true, '5950': true, '5951': true,
        // PL合計科目
        '60000': true, '80000': true, '83000': true, '90000': true, '99000': true
    };
    
    // 合計科目を太字にする（最適化実装）
    $('.table-responsive table tbody tr').each(function() {
        var firstCell = $(this).find('td:first');
        var cellText = firstCell.text().trim();
        
        // コードセットを使ってチェック（オブジェクトのプロパティ検索はO(1)で高速）
        if (totalAccountCodes[cellText]) {
            $(this).find('td').css({
                'font-weight': 'bold',
                'color': '#000000',
                'background-color': '#f8f9fa'
            });
        }
    });
});
</script>
{% endblock %}