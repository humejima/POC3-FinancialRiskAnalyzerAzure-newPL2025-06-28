{% extends "layout.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="display-5 mb-3"><i class="fa-solid fa-code-fork"></i> 勘定科目マッピング</h1>
        <p class="lead">取り込んだ勘定科目を標準勘定科目にマッピングします。</p>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">JA・年度選択</h5>
                <form action="{{ url_for('select_ja') }}" method="post" class="mt-2">
                    <div class="mb-3">
                        <label for="ja_code" class="form-label">JA</label>
                        <select name="ja_code" id="ja_code" class="form-select">
                            {% for ja in jas %}
                            <option value="{{ ja.ja_code }}" {% if ja.ja_code == selected_ja_code %}selected{% endif %}>
                                {{ ja.name }} ({{ ja.prefecture }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="year" class="form-label">年度</label>
                        <select name="year" id="year" class="form-select">
                            {% for ja in jas %}
                            <option value="{{ ja.year }}" {% if ja.year == selected_year %}selected{% endif %}>
                                {{ ja.year }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <input type="hidden" name="redirect_url" value="{{ url_for('mapping', file_type=file_type) }}">
                    <button type="submit" class="btn btn-secondary w-100">選択</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- File Type Tabs -->
<ul class="nav nav-tabs mb-4">
    <li class="nav-item">
        <a class="nav-link {% if file_type == 'bs' %}active{% endif %}" href="{{ url_for('mapping', file_type='bs') }}">
            貸借対照表 (BS)
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if file_type == 'pl' %}active{% endif %}" href="{{ url_for('mapping', file_type='pl') }}">
            損益計算書 (PL)
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if file_type == 'cf' %}active{% endif %}" href="{{ url_for('mapping', file_type='cf') }}">
            キャッシュフロー計算書 (CF)
        </a>
    </li>
</ul>

<!-- View Mode Tabs -->
<ul class="nav nav-tabs mb-4">
    <li class="nav-item">
        <a class="nav-link {% if not show_all %}active{% endif %}" href="{{ url_for('mapping', file_type=file_type, show_all='false') }}">
            マッピング管理
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if show_all %}active{% endif %}" href="{{ url_for('mapping', file_type=file_type, show_all='true') }}">
            CSV全データ一覧
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="#standard-accounts-tab" data-bs-toggle="modal" data-bs-target="#standardAccountsModal">
            標準勘定科目一覧
        </a>
    </li>
</ul>

{% if not show_all %}
<!-- マッピング管理表示 -->
<div class="row">
    <!-- Mapping Card -->
    <div class="col-md-5 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">勘定科目マッピング</h5>
            </div>
            <div class="card-body">
                <!-- 完全一致マッピング -->
                <div class="mb-4">
                    <h6 class="fw-bold"><i class="fa-solid fa-equals"></i> 完全一致マッピング</h6>
                    <p>標準勘定科目と完全に一致する名称の勘定科目を自動的にマッピングします。</p>
                    
                    <form action="{{ url_for('exact_match') }}" method="post">
                        <input type="hidden" name="ja_code" value="{{ selected_ja_code }}">
                        <input type="hidden" name="year" value="{{ selected_year }}">
                        <input type="hidden" name="file_type" value="{{ file_type }}">
                        
                        <button type="submit" class="btn btn-success">
                            <i class="fa-solid fa-check-double"></i> 完全一致マッピング実行
                        </button>
                    </form>
                </div>
                
                <hr>
                
                <!-- AIマッピング -->
                <div class="mt-4">
                    <h6 class="fw-bold"><i class="fa-solid fa-robot"></i> AI支援マッピング</h6>
                    <p>AIを使って未マッピングの勘定科目を自動的にマッピングします。</p>
                    
                    <form action="{{ url_for('ai_map') }}" method="post">
                        <input type="hidden" name="ja_code" value="{{ selected_ja_code }}">
                        <input type="hidden" name="year" value="{{ selected_year }}">
                        <input type="hidden" name="file_type" value="{{ file_type }}">
                        
                        <div class="mb-3">
                            <label for="confidence_threshold" class="form-label">信頼度しきい値</label>
                            <div class="d-flex align-items-center">
                                <input type="range" class="form-range me-2" id="confidence_threshold" name="confidence_threshold" 
                                       min="0.5" max="0.9" step="0.1" value="0.7">
                                <span id="confidence_value">0.7</span>
                            </div>
                            <div class="form-text">高い値を設定するとより確実なマッピングのみ適用されます。</div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fa-solid fa-robot"></i> AIマッピング実行
                        </button>
                    </form>
                    
                    <div class="alert alert-info mt-3">
                        <i class="fa-solid fa-info-circle"></i>
                        AIマッピングは、OpenAI APIを使用して勘定科目を分析し、最適な標準勘定科目を提案します。
                    </div>
                </div>
                
                <hr>
                
                <!-- 一括マッピング -->
                <div class="mt-4">
                    <h6 class="fw-bold"><i class="fa-solid fa-list-check"></i> 一括マッピング</h6>
                    <p>完全一致マッピングとAIマッピングを順番に実行します。</p>
                    
                    <form action="{{ url_for('auto_map') }}" method="post">
                        <input type="hidden" name="ja_code" value="{{ selected_ja_code }}">
                        <input type="hidden" name="year" value="{{ selected_year }}">
                        <input type="hidden" name="file_type" value="{{ file_type }}">
                        <input type="hidden" name="confidence_threshold" value="0.7">
                        
                        <button type="submit" class="btn btn-outline-primary">
                            <i class="fa-solid fa-play"></i> 一括マッピング実行
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Unmapped Accounts Card -->
    <div class="col-md-7">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">未マッピング勘定科目</h5>
                {% if unmapped_accounts %}
                <span class="badge bg-warning">{{ unmapped_accounts|length }}件</span>
                {% endif %}
            </div>
            <div class="card-body p-0">
                {% if unmapped_accounts %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>勘定科目名</th>
                                <th>金額</th>
                                <th>アクション</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for account in unmapped_accounts %}
                            <tr id="account-row-{{ account.id }}">
                                <td>{{ account.account_name }}</td>
                                <td class="text-end">{{ "{:,.0f}".format(account.current_value) }}</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-outline-primary map-account-btn" 
                                                data-account-id="{{ account.id }}" 
                                                data-account-name="{{ account.account_name }}">
                                            マッピング
                                        </button>
                                        <button class="btn btn-sm btn-outline-info ai-recommend-btn"
                                                data-account-id="{{ account.id }}"
                                                data-account-name="{{ account.account_name }}"
                                                data-file-type="{{ file_type }}">
                                            <i class="fa-solid fa-lightbulb"></i> AIレコメンド
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Finalize Mapping Form -->
                <div class="card-footer bg-light">
                    <form action="{{ url_for('finalize_mapping') }}" method="post" class="d-flex justify-content-end">
                        <input type="hidden" name="ja_code" value="{{ selected_ja_code }}">
                        <input type="hidden" name="year" value="{{ selected_year }}">
                        <input type="hidden" name="file_type" value="{{ file_type }}">
                        <button type="submit" class="btn btn-success">
                            <i class="fa-solid fa-check-circle"></i> マッピング確定
                        </button>
                    </form>
                </div>
                {% else %}
                <div class="text-center p-4">
                    <p class="text-muted">すべての勘定科目がマッピング済みです。または対象データがありません。</p>
                    {% if existing_mappings %}
                    <form action="{{ url_for('finalize_mapping') }}" method="post">
                        <input type="hidden" name="ja_code" value="{{ selected_ja_code }}">
                        <input type="hidden" name="year" value="{{ selected_year }}">
                        <input type="hidden" name="file_type" value="{{ file_type }}">
                        <button type="submit" class="btn btn-success">
                            <i class="fa-solid fa-check-circle"></i> マッピング確定
                        </button>
                    </form>
                    {% else %}
                    <a href="{{ url_for('data_import') }}" class="btn btn-primary">
                        <i class="fa-solid fa-file-import"></i> データ取込へ
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Existing Mappings Card -->
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">マッピング済み勘定科目</h5>
                {% if existing_mappings %}
                <span class="badge bg-success">{{ existing_mappings|length }}件</span>
                {% endif %}
            </div>
            <div class="card-body p-0">
                {% if existing_mappings %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead>
                            <tr>
                                <th>元の勘定科目名</th>
                                <th>標準勘定科目コード</th>
                                <th>標準勘定科目名</th>
                                <th>信頼度</th>
                                <th>アクション</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for mapping in existing_mappings %}
                            <tr>
                                <td>{{ mapping.original_account_name }}</td>
                                <td>{{ mapping.standard_account_code }}</td>
                                <td>{{ mapping.standard_account_name }}</td>
                                <td>
                                    {% if mapping.confidence > 0.9 %}
                                    <span class="badge bg-success">高 ({{ "%.2f"|format(mapping.confidence) }})</span>
                                    {% elif mapping.confidence > 0.7 %}
                                    <span class="badge bg-info">中 ({{ "%.2f"|format(mapping.confidence) }})</span>
                                    {% else %}
                                    <span class="badge bg-warning">低 ({{ "%.2f"|format(mapping.confidence) }})</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-warning edit-mapping-btn"
                                            data-mapping-id="{{ mapping.id }}"
                                            data-original-name="{{ mapping.original_account_name }}"
                                            data-standard-code="{{ mapping.standard_account_code }}">
                                        編集
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center p-4">
                    <p class="text-muted">マッピング済み勘定科目がありません。</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% else %}
<!-- CSV全データ一覧表示 -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">CSV全データ一覧</h5>
        <span class="badge bg-primary">{{ all_accounts|length }}件</span>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-sm">
                <thead>
                    <tr>
                        <th>行番号</th>
                        <th>勘定科目名</th>
                        <th>カテゴリ</th>
                        <th>金額</th>
                        <th>前年金額</th>
                        <th>マッピング状態</th>
                        <th>標準勘定科目</th>
                    </tr>
                </thead>
                <tbody>
                    {% for account in all_accounts %}
                    <tr>
                        <td>{{ account.row_number }}</td>
                        <td>{{ account.account_name }}</td>
                        <td>{{ account.category }}</td>
                        <td class="text-end">{{ "{:,.0f}".format(account.current_value) }}</td>
                        <td class="text-end">{{ "{:,.0f}".format(account.previous_value) if account.previous_value is not none else "-" }}</td>
                        <td>
                            {% if account.is_mapped %}
                            <span class="badge bg-success">マッピング済</span>
                            {% else %}
                            <span class="badge bg-warning">未マッピング</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if account.account_name in mapping_lookup %}
                            {{ mapping_lookup[account.account_name].standard_account_code }} 
                            ({{ mapping_lookup[account.account_name].standard_account_name }})
                            {% else %}
                            -
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Standard Accounts Modal -->
<div class="modal fade" id="standardAccountsModal" tabindex="-1" aria-labelledby="standardAccountsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="standardAccountsModalLabel">標準勘定科目一覧 ({{ file_type|upper }})</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="standardAccountsTable">
                        <thead class="table-dark">
                            <tr>
                                <th>コード</th>
                                <th>標準勘定科目名</th>
                                <th>タイプ</th>
                                <th>カテゴリー</th>
                                <th>説明</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for account in standard_accounts %}
                            <tr>
                                <td>{{ account.code }}</td>
                                <td>{{ account.name }}</td>
                                <td>{{ account.account_type }}</td>
                                <td>{{ account.category }}</td>
                                <td>{{ account.description }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
            </div>
        </div>
    </div>
</div>

<!-- AI Recommendation Modal -->
<div class="modal fade" id="aiRecommendModal" tabindex="-1" aria-labelledby="aiRecommendModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="aiRecommendModalLabel">AIレコメンデーション</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="aiRecommendLoading" class="text-center my-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">AIによる分析中...</p>
                </div>
                <div id="aiRecommendError" class="alert alert-danger d-none">
                    <i class="fa-solid fa-triangle-exclamation"></i> 
                    <span id="aiRecommendErrorMessage">エラーが発生しました</span>
                </div>
                <div id="aiRecommendResult" class="d-none">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="fw-bold">元の勘定科目名</h6>
                            <p id="aiOriginalAccount" class="lead"></p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-bold">AI信頼度</h6>
                            <div id="aiConfidence"></div>
                        </div>
                    </div>
                    <hr>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <h6 class="fw-bold">推奨勘定科目コード</h6>
                            <p id="aiRecommendCode" class="lead"></p>
                        </div>
                        <div class="col-md-4">
                            <h6 class="fw-bold">推奨勘定科目名</h6>
                            <p id="aiRecommendName" class="lead"></p>
                        </div>
                        <div class="col-md-4">
                            <h6 class="fw-bold">勘定科目タイプ</h6>
                            <p id="aiRecommendType" class="lead"></p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">AIの分析理由</h6>
                                </div>
                                <div class="card-body">
                                    <p id="aiRationale"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                <button type="button" id="apply-recommendation-btn" class="btn btn-primary d-none">
                    <i class="fa-solid fa-check"></i> このレコメンドを適用
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Manual Mapping Modal -->
<div class="modal fade" id="mappingModal" tabindex="-1" aria-labelledby="mappingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mappingModalLabel">勘定科目マッピング</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="manual-mapping-form" action="{{ url_for('manual_map') }}" method="post">
                    <input type="hidden" name="ja_code" value="{{ selected_ja_code }}">
                    <input type="hidden" name="year" value="{{ selected_year }}">
                    <input type="hidden" name="file_type" value="{{ file_type }}">
                    <input type="hidden" id="account_id_input" name="account_id" value="">
                    
                    <div class="mb-3">
                        <label for="original_account_name" class="form-label">元の勘定科目名</label>
                        <input type="text" class="form-control" id="original_account_name" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label for="standard_account_code" class="form-label">標準勘定科目</label>
                        <select name="standard_account_code" id="standard_account_code" class="form-select">
                            <option value="">選択してください</option>
                            {% for account in standard_accounts %}
                            <option value="{{ account.code }}">{{ account.code }} - {{ account.name }} ({{ account.account_type }})</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" id="save-mapping-btn" class="btn btn-primary">保存</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Confidence slider
    const confidenceSlider = document.getElementById('confidence_threshold');
    const confidenceValue = document.getElementById('confidence_value');
    
    if (confidenceSlider && confidenceValue) {
        confidenceSlider.addEventListener('input', function() {
            confidenceValue.textContent = this.value;
        });
    }
    
    // Manual mapping modal
    const mappingModal = new bootstrap.Modal(document.getElementById('mappingModal'));
    const mapButtons = document.querySelectorAll('.map-account-btn');
    const accountIdInput = document.getElementById('account_id_input');
    const originalAccountInput = document.getElementById('original_account_name');
    const saveButton = document.getElementById('save-mapping-btn');
    const mappingForm = document.getElementById('manual-mapping-form');
    
    mapButtons.forEach(button => {
        button.addEventListener('click', function() {
            const accountId = this.getAttribute('data-account-id');
            const accountName = this.getAttribute('data-account-name');
            
            accountIdInput.value = accountId;
            originalAccountInput.value = accountName;
            
            mappingModal.show();
        });
    });
    
    if (saveButton) {
        saveButton.addEventListener('click', function() {
            mappingForm.submit();
        });
    }
    
    // AI Recommendation modal
    const aiRecommendModal = new bootstrap.Modal(document.getElementById('aiRecommendModal'));
    const aiRecommendButtons = document.querySelectorAll('.ai-recommend-btn');
    const applyRecommendationBtn = document.getElementById('apply-recommendation-btn');
    
    // AI recommendation behavior
    aiRecommendButtons.forEach(button => {
        button.addEventListener('click', function() {
            const accountId = this.getAttribute('data-account-id');
            const accountName = this.getAttribute('data-account-name');
            const fileType = this.getAttribute('data-file-type');
            
            // Show loading state
            document.getElementById('aiRecommendLoading').classList.remove('d-none');
            document.getElementById('aiRecommendResult').classList.add('d-none');
            document.getElementById('aiRecommendError').classList.add('d-none');
            applyRecommendationBtn.classList.add('d-none');
            
            // Show the modal
            aiRecommendModal.show();
            
            // Make AJAX request to get AI recommendation
            const formData = new FormData();
            formData.append('account_name', accountName);
            formData.append('file_type', fileType);
            
            fetch('/ai_recommendation', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('aiRecommendLoading').classList.add('d-none');
                
                if (data.status === 'success') {
                    // Show results
                    document.getElementById('aiRecommendResult').classList.remove('d-none');
                    document.getElementById('aiOriginalAccount').textContent = accountName;
                    document.getElementById('aiRecommendCode').textContent = data.recommendation.standard_account_code;
                    document.getElementById('aiRecommendName').textContent = data.recommendation.standard_account_name;
                    document.getElementById('aiRecommendType').textContent = data.recommendation.account_type || '-';
                    document.getElementById('aiRationale').textContent = data.recommendation.rationale;
                    
                    // Set confidence badge
                    const confidenceEl = document.getElementById('aiConfidence');
                    const confidence = data.recommendation.confidence;
                    
                    let badgeClass = 'bg-warning';
                    let confidenceText = '低';
                    
                    if (confidence > 0.9) {
                        badgeClass = 'bg-success';
                        confidenceText = '高';
                    } else if (confidence > 0.7) {
                        badgeClass = 'bg-info';
                        confidenceText = '中';
                    }
                    
                    confidenceEl.innerHTML = `<span class="badge ${badgeClass}">${confidenceText} (${(confidence * 100).toFixed(1)}%)</span>`;
                    
                    // Setup apply button
                    applyRecommendationBtn.classList.remove('d-none');
                    applyRecommendationBtn.onclick = function() {
                        // Create form and submit
                        const form = document.createElement('form');
                        form.method = 'post';
                        form.action = '/manual_map';
                        form.style.display = 'none';
                        
                        const fields = {
                            'ja_code': '{{ selected_ja_code }}',
                            'year': '{{ selected_year }}',
                            'file_type': fileType,
                            'account_id': accountId,
                            'standard_account_code': data.recommendation.standard_account_code
                        };
                        
                        for (const key in fields) {
                            const input = document.createElement('input');
                            input.type = 'hidden';
                            input.name = key;
                            input.value = fields[key];
                            form.appendChild(input);
                        }
                        
                        document.body.appendChild(form);
                        form.submit();
                    };
                } else {
                    // Show error
                    document.getElementById('aiRecommendError').classList.remove('d-none');
                    document.getElementById('aiRecommendErrorMessage').textContent = data.message || 'AIレコメンデーションの取得中にエラーが発生しました。';
                }
            })
            .catch(error => {
                document.getElementById('aiRecommendLoading').classList.add('d-none');
                document.getElementById('aiRecommendError').classList.remove('d-none');
                document.getElementById('aiRecommendErrorMessage').textContent = 'サーバーエラーが発生しました。';
                console.error('Error fetching AI recommendation:', error);
            });
        });
    });
    
    // Edit mapping buttons
    const editMappingButtons = document.querySelectorAll('.edit-mapping-btn');
    
    editMappingButtons.forEach(button => {
        button.addEventListener('click', function() {
            const originalName = this.getAttribute('data-original-name');
            const standardCode = this.getAttribute('data-standard-code');
            const accountId = this.getAttribute('data-account-id');
            
            // Set form values
            originalAccountInput.value = originalName;
            
            if (accountId) {
                accountIdInput.value = accountId;
            } else {
                // If not found, we're editing an existing mapping
                // In a real app, this would use the mapping ID instead
                accountIdInput.value = 'existing_' + originalName;
            }
            
            // Select the right standard account
            if (standardAccountSelect) {
                for (let i = 0; i < standardAccountSelect.options.length; i++) {
                    if (standardAccountSelect.options[i].value === standardCode) {
                        standardAccountSelect.selectedIndex = i;
                        break;
                    }
                }
            }
            
            mappingModal.show();
        });
    });
});
</script>
{% endblock %}