{% extends "layout.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="display-5 mb-3"><i class="fa-solid fa-file-lines"></i> レポート</h1>
        <p class="lead">財務分析結果からレポートを生成します。</p>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">JA・年度選択</h5>
                <form action="{{ url_for('select_ja') }}" method="post" class="mt-2">
                    <div class="mb-3">
                        <label for="ja_code" class="form-label">JA</label>
                        <select name="ja_code" id="ja_code" class="form-select">
                            {% for ja in jas %}
                            <option value="{{ ja.ja_code }}" {% if ja.ja_code == selected_ja_code %}selected{% endif %}>
                                {{ ja.name }} ({{ ja.prefecture }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="year" class="form-label">年度</label>
                        <select name="year" id="year" class="form-select">
                            <option value="2025" {% if selected_year == 2025 %}selected{% endif %}>2025</option>
                            <option value="2024" {% if selected_year == 2024 %}selected{% endif %}>2024</option>
                            <option value="2023" {% if selected_year == 2023 %}selected{% endif %}>2023</option>
                            <option value="2022" {% if selected_year == 2022 %}selected{% endif %}>2022</option>
                            <option value="2021" {% if selected_year == 2021 %}selected{% endif %}>2021</option>
                        </select>
                    </div>
                    <input type="hidden" name="redirect_url" value="{{ url_for('reports') }}">
                    <button type="submit" class="btn btn-secondary w-100">選択</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Report Type Tabs -->
<ul class="nav nav-tabs mb-4">
    <li class="nav-item">
        <a class="nav-link {% if report_type == 'summary' %}active{% endif %}" href="{{ url_for('reports', type='summary') }}">
            財務指標サマリー
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if report_type == 'detailed' %}active{% endif %}" href="{{ url_for('reports', type='detailed') }}">
            詳細リスク分析
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if report_type == 'improvement' %}active{% endif %}" href="{{ url_for('reports', type='improvement') }}">
            改善提案
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if report_type == 'trend' %}active{% endif %}" href="{{ url_for('reports', type='trend') }}">
            経年変化
        </a>
    </li>
</ul>

<!-- Report Content -->
<div class="row">
    <div class="col-12">
        {% if report_type == 'summary' %}
        <!-- Summary Report -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">財務指標サマリーレポート</h5>
                <button class="btn btn-sm btn-outline-secondary" id="printReportBtn">
                    <i class="fa-solid fa-print"></i> 印刷
                </button>
            </div>
            <div class="card-body">
                {% if analysis_results %}
                <div id="report-content">
                    <div class="text-center mb-4">
                        <h3>財務指標サマリーレポート</h3>
                        <p>{{ ja_info.name }} ({{ ja_info.prefecture }}) - {{ selected_year }}年度</p>
                        <p class="text-muted">作成日: {{ now }}</p>
                    </div>
                    
                    <!-- Risk Overview -->
                    <div class="mb-4">
                        <h4>リスク評価概要</h4>
                        <div class="row">
                            <div class="col-md-6">
                                {% if risk_assessment and risk_assessment.status == 'success' %}
                                <p><strong>総合リスク評価:</strong> 
                                    <span class="
                                        {% if risk_assessment.overall_risk_level == '極めて高い' %}text-danger
                                        {% elif risk_assessment.overall_risk_level == '高い' %}text-warning
                                        {% elif risk_assessment.overall_risk_level == '中程度' %}text-info
                                        {% elif risk_assessment.overall_risk_level == '低い' %}text-success
                                        {% elif risk_assessment.overall_risk_level == '極めて低い' %}text-primary
                                        {% endif %}
                                    ">{{ risk_assessment.overall_risk_level }}</span>
                                </p>
                                <p><strong>リスクスコア:</strong> {{ "%.2f"|format(risk_assessment.overall_score) }}/5.0</p>
                                {% else %}
                                <p>リスク評価データがありません。</p>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <canvas id="riskRadarChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Key Indicators -->
                    <div class="mb-4">
                        <h4>主要財務指標</h4>
                        <div class="row">
                            {% for category, category_name in {
                                'liquidity': '流動性指標',
                                'profitability': '収益性指標',
                                'safety': '安全性指標',
                                'efficiency': '効率性指標',
                                'cash_flow': 'キャッシュフロー指標'
                            }.items() %}
                            <div class="col-md-6 mb-3">
                                <h5>{{ category_name }}</h5>
                                <table class="table table-sm table-bordered">
                                    <thead>
                                        <tr>
                                            <th>指標</th>
                                            <th>値</th>
                                            <th>リスク</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for result in analysis_results %}
                                        {% if result.analysis_type == category %}
                                        <tr>
                                            <td>
                                                {% if result.indicator_name == 'current_ratio' %}流動比率
                                                {% elif result.indicator_name == 'quick_ratio' %}当座比率
                                                {% elif result.indicator_name == 'cash_ratio' %}現金比率
                                                {% elif result.indicator_name == 'working_capital' %}運転資本
                                                {% elif result.indicator_name == 'roa' %}総資産利益率
                                                {% elif result.indicator_name == 'roe' %}自己資本利益率
                                                {% elif result.indicator_name == 'profit_margin' %}利益率
                                                {% elif result.indicator_name == 'operating_margin' %}営業利益率
                                                {% elif result.indicator_name == 'debt_ratio' %}負債比率
                                                {% elif result.indicator_name == 'equity_ratio' %}自己資本比率
                                                {% elif result.indicator_name == 'debt_to_equity' %}負債資本比率
                                                {% elif result.indicator_name == 'interest_coverage' %}インタレストカバレッジレシオ
                                                {% elif result.indicator_name == 'asset_turnover' %}総資産回転率
                                                {% elif result.indicator_name == 'receivables_turnover' %}売上債権回転率
                                                {% elif result.indicator_name == 'inventory_turnover' %}棚卸資産回転率
                                                {% elif result.indicator_name == 'days_sales_outstanding' %}売上債権回収期間
                                                {% elif result.indicator_name == 'ocf_to_debt' %}営業CF対負債比率
                                                {% elif result.indicator_name == 'cf_to_revenue' %}CF対売上比率
                                                {% elif result.indicator_name == 'cf_to_net_income' %}CF対純利益比率
                                                {% elif result.indicator_name == 'free_cash_flow' %}フリーキャッシュフロー
                                                {% else %}{{ result.indicator_name }}
                                                {% endif %}
                                            </td>
                                            <td class="text-end">{{ "%.2f"|format(result.indicator_value) }}</td>
                                            <td>
                                                {% if result.risk_level == "高" %}
                                                <span class="badge bg-danger">{{ result.risk_level }}</span>
                                                {% elif result.risk_level == "中高" %}
                                                <span class="badge bg-warning">{{ result.risk_level }}</span>
                                                {% elif result.risk_level == "中" %}
                                                <span class="badge bg-info">{{ result.risk_level }}</span>
                                                {% elif result.risk_level == "低中" %}
                                                <span class="badge bg-success">{{ result.risk_level }}</span>
                                                {% elif result.risk_level == "低" %}
                                                <span class="badge bg-primary">{{ result.risk_level }}</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Summary Comments -->
                    <div class="mb-4">
                        <h4>総評</h4>
                        {% if risk_assessment and risk_assessment.status == 'success' %}
                        <p>
                            {{ ja_info.name }}の財務状況は総合的に見て
                            <strong class="
                                {% if risk_assessment.overall_risk_level == '極めて高い' %}text-danger
                                {% elif risk_assessment.overall_risk_level == '高い' %}text-warning
                                {% elif risk_assessment.overall_risk_level == '中程度' %}text-info
                                {% elif risk_assessment.overall_risk_level == '低い' %}text-success
                                {% elif risk_assessment.overall_risk_level == '極めて低い' %}text-primary
                                {% endif %}
                            ">{{ risk_assessment.overall_risk_level }}</strong>
                            リスク状態にあります。
                        </p>
                        
                        {% set highest_risk_category = '' %}
                        {% set highest_risk_score = 0 %}
                        {% set lowest_risk_category = '' %}
                        {% set lowest_risk_score = 5 %}
                        
                        {% for category, score in risk_assessment.category_scores.items() %}
                            {% if score > highest_risk_score %}
                                {% set highest_risk_category = category %}
                                {% set highest_risk_score = score %}
                            {% endif %}
                            {% if score < lowest_risk_score %}
                                {% set lowest_risk_category = category %}
                                {% set lowest_risk_score = score %}
                            {% endif %}
                        {% endfor %}
                        
                        <p>
                            特に 
                            <strong>
                            {% if highest_risk_category == 'liquidity' %}流動性
                            {% elif highest_risk_category == 'profitability' %}収益性
                            {% elif highest_risk_category == 'safety' %}安全性
                            {% elif highest_risk_category == 'efficiency' %}効率性
                            {% elif highest_risk_category == 'cash_flow' %}キャッシュフロー
                            {% else %}{{ highest_risk_category }}
                            {% endif %}
                            </strong>
                            の分野においてリスクが高く、注意が必要です。
                        </p>
                        
                        <p>
                            一方、
                            <strong>
                            {% if lowest_risk_category == 'liquidity' %}流動性
                            {% elif lowest_risk_category == 'profitability' %}収益性
                            {% elif lowest_risk_category == 'safety' %}安全性
                            {% elif lowest_risk_category == 'efficiency' %}効率性
                            {% elif lowest_risk_category == 'cash_flow' %}キャッシュフロー
                            {% else %}{{ lowest_risk_category }}
                            {% endif %}
                            </strong>
                            の分野は比較的堅調です。
                        </p>
                        {% else %}
                        <p>リスク評価データがありません。</p>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div class="text-center p-5">
                    <p class="text-muted">分析データがありません。「分析」セクションで指標計算を実行してください。</p>
                    <a href="{{ url_for('analysis') }}" class="btn btn-primary">分析へ移動</a>
                </div>
                {% endif %}
            </div>
        </div>
        
        {% elif report_type == 'detailed' %}
        <!-- Detailed Risk Analysis Report -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">詳細リスク分析レポート</h5>
                <button class="btn btn-sm btn-outline-secondary" id="printReportBtn">
                    <i class="fa-solid fa-print"></i> 印刷
                </button>
            </div>
            <div class="card-body">
                {% if analysis_results %}
                <div id="report-content">
                    <div class="text-center mb-4">
                        <h3>詳細リスク分析レポート</h3>
                        <p>{{ ja_info.name }} ({{ ja_info.prefecture }}) - {{ selected_year }}年度</p>
                        <p class="text-muted">作成日: {{ now }}</p>
                    </div>
                    
                    <!-- Risk Overview -->
                    <div class="mb-4">
                        <h4>リスク評価概要</h4>
                        {% if risk_assessment and risk_assessment.status == 'success' %}
                        <p><strong>総合リスク評価:</strong> 
                            <span class="
                                {% if risk_assessment.overall_risk_level == '極めて高い' %}text-danger
                                {% elif risk_assessment.overall_risk_level == '高い' %}text-warning
                                {% elif risk_assessment.overall_risk_level == '中程度' %}text-info
                                {% elif risk_assessment.overall_risk_level == '低い' %}text-success
                                {% elif risk_assessment.overall_risk_level == '極めて低い' %}text-primary
                                {% endif %}
                            ">{{ risk_assessment.overall_risk_level }}</span>
                        </p>
                        <p><strong>リスクスコア:</strong> {{ "%.2f"|format(risk_assessment.overall_score) }}/5.0</p>
                        {% else %}
                        <p>リスク評価データがありません。</p>
                        {% endif %}
                    </div>
                    
                    <!-- Detailed Analysis by Category -->
                    {% for category, category_name in {
                        'liquidity': '流動性リスク分析',
                        'profitability': '収益性リスク分析',
                        'safety': '安全性リスク分析',
                        'efficiency': '効率性リスク分析',
                        'cash_flow': 'キャッシュフローリスク分析'
                    }.items() %}
                    <div class="mb-4">
                        <h4>{{ category_name }}</h4>
                        
                        {% set category_results = [] %}
                        {% for result in analysis_results %}
                            {% if result.analysis_type == category %}
                                {% set category_results = category_results + [result] %}
                            {% endif %}
                        {% endfor %}
                        
                        {% if category_results %}
                        <div class="mb-3">
                            <canvas id="chart{{ category }}" height="200"></canvas>
                        </div>
                        
                        {% for result in category_results %}
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    {% if result.indicator_name == 'current_ratio' %}流動比率
                                    {% elif result.indicator_name == 'quick_ratio' %}当座比率
                                    {% elif result.indicator_name == 'cash_ratio' %}現金比率
                                    {% elif result.indicator_name == 'working_capital' %}運転資本
                                    {% elif result.indicator_name == 'roa' %}総資産利益率
                                    {% elif result.indicator_name == 'roe' %}自己資本利益率
                                    {% elif result.indicator_name == 'profit_margin' %}利益率
                                    {% elif result.indicator_name == 'operating_margin' %}営業利益率
                                    {% elif result.indicator_name == 'debt_ratio' %}負債比率
                                    {% elif result.indicator_name == 'equity_ratio' %}自己資本比率
                                    {% elif result.indicator_name == 'debt_to_equity' %}負債資本比率
                                    {% elif result.indicator_name == 'interest_coverage' %}インタレストカバレッジレシオ
                                    {% elif result.indicator_name == 'asset_turnover' %}総資産回転率
                                    {% elif result.indicator_name == 'receivables_turnover' %}売上債権回転率
                                    {% elif result.indicator_name == 'inventory_turnover' %}棚卸資産回転率
                                    {% elif result.indicator_name == 'days_sales_outstanding' %}売上債権回収期間
                                    {% elif result.indicator_name == 'ocf_to_debt' %}営業CF対負債比率
                                    {% elif result.indicator_name == 'cf_to_revenue' %}CF対売上比率
                                    {% elif result.indicator_name == 'cf_to_net_income' %}CF対純利益比率
                                    {% elif result.indicator_name == 'free_cash_flow' %}フリーキャッシュフロー
                                    {% else %}{{ result.indicator_name }}
                                    {% endif %}
                                </h5>
                                {% if result.risk_level == "高" %}
                                <span class="badge bg-danger">{{ result.risk_level }}リスク</span>
                                {% elif result.risk_level == "中高" %}
                                <span class="badge bg-warning">{{ result.risk_level }}リスク</span>
                                {% elif result.risk_level == "中" %}
                                <span class="badge bg-info">{{ result.risk_level }}リスク</span>
                                {% elif result.risk_level == "低中" %}
                                <span class="badge bg-success">{{ result.risk_level }}リスク</span>
                                {% elif result.risk_level == "低" %}
                                <span class="badge bg-primary">{{ result.risk_level }}リスク</span>
                                {% endif %}
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>現在の値:</strong> {{ "%.2f"|format(result.indicator_value) }}</p>
                                        <p><strong>基準値:</strong> {{ "%.2f"|format(result.benchmark) if result.benchmark else 'N/A' }}</p>
                                        <p><strong>リスクスコア:</strong> {{ result.risk_score }}/5</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>分析:</strong></p>
                                        <p>{{ result.analysis_result }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <p>このカテゴリの分析データがありません。</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center p-5">
                    <p class="text-muted">分析データがありません。「分析」セクションで指標計算を実行してください。</p>
                    <a href="{{ url_for('analysis') }}" class="btn btn-primary">分析へ移動</a>
                </div>
                {% endif %}
            </div>
        </div>
        
        {% elif report_type == 'improvement' %}
        <!-- Improvement Suggestions Report -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">改善提案レポート</h5>
                <button class="btn btn-sm btn-outline-secondary" id="printReportBtn">
                    <i class="fa-solid fa-print"></i> 印刷
                </button>
            </div>
            <div class="card-body">
                {% if improvement_suggestions %}
                <div id="report-content">
                    <div class="text-center mb-4">
                        <h3>財務改善提案レポート</h3>
                        <p>{{ ja_info.name }} ({{ ja_info.prefecture }}) - {{ selected_year }}年度</p>
                        <p class="text-muted">作成日: {{ now }}</p>
                    </div>
                    
                    <div class="alert alert-info mb-4">
                        <h5><i class="fa-solid fa-info-circle"></i> レポート概要</h5>
                        <p>{{ improvement_suggestions.message }}</p>
                    </div>
                    
                    {% if improvement_suggestions.suggestions %}
                    {% for type, suggestions in improvement_suggestions.suggestions.items() %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                {% if type == '流動性' %}流動性改善提案
                                {% elif type == '収益性' %}収益性改善提案
                                {% elif type == '安全性' %}安全性改善提案
                                {% elif type == '効率性' %}効率性改善提案
                                {% elif type == 'キャッシュフロー' %}キャッシュフロー改善提案
                                {% else %}{{ type }}改善提案
                                {% endif %}
                            </h5>
                        </div>
                        <div class="card-body">
                            <ol class="mb-0">
                                {% for suggestion in suggestions %}
                                <li class="mb-2">{{ suggestion }}</li>
                                {% endfor %}
                            </ol>
                        </div>
                    </div>
                    {% endfor %}
                    
                    <div class="alert alert-warning">
                        <h5><i class="fa-solid fa-triangle-exclamation"></i> 注意事項</h5>
                        <p>本レポートは財務データに基づく分析結果から自動的に生成された改善提案です。実際の改善策を検討する際は、JAの事業特性や経営方針、環境要因なども考慮した総合的な判断が必要です。</p>
                    </div>
                    {% else %}
                    <div class="alert alert-success">
                        <h5><i class="fa-solid fa-check-circle"></i> 良好な財務状態</h5>
                        <p>現在の財務状態は良好であり、特に重大な改善が必要な項目はありません。引き続き現在の経営方針を維持することをお勧めします。</p>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div class="text-center p-5">
                    <p class="text-muted">改善提案データがありません。「分析」セクションで指標計算を実行してください。</p>
                    <a href="{{ url_for('analysis') }}" class="btn btn-primary">分析へ移動</a>
                </div>
                {% endif %}
            </div>
        </div>
        
        {% elif report_type == 'trend' %}
        <!-- Trend Analysis Report -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">経年変化レポート</h5>
            </div>
            <div class="card-body">
                <div class="text-center p-5">
                    <p class="text-muted">経年変化データはまだ利用できません。複数年度のデータを取り込むと表示されます。</p>
                    <a href="{{ url_for('data_import') }}" class="btn btn-primary">
                        <i class="fa-solid fa-file-import"></i> データ取込へ
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Print report functionality
    const printReportBtn = document.getElementById('printReportBtn');
    if (printReportBtn) {
        printReportBtn.addEventListener('click', function() {
            const reportContent = document.getElementById('report-content');
            const originalContents = document.body.innerHTML;
            
            document.body.innerHTML = reportContent.innerHTML;
            window.print();
            document.body.innerHTML = originalContents;
            location.reload();
        });
    }
    
    {% if report_type == 'summary' and risk_assessment and risk_assessment.status == 'success' %}
    // Risk radar chart
    fetch('/api/risk_data?ja_code={{ selected_ja_code }}&year={{ selected_year }}')
        .then(response => response.json())
        .then(response => {
            if (response.status === 'success') {
                // Draw radar chart
                const ctx = document.getElementById('riskRadarChart').getContext('2d');
                new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: response.data.labels,
                        datasets: [{
                            label: 'リスク耐性',
                            data: response.data.values,
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgba(54, 162, 235, 1)'
                        }]
                    },
                    options: {
                        scales: {
                            r: {
                                angleLines: {
                                    color: 'rgba(255, 255, 255, 0.2)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.2)'
                                },
                                pointLabels: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                ticks: {
                                    backdropColor: 'transparent',
                                    color: 'rgba(255, 255, 255, 0.7)',
                                    z: 1,
                                    stepSize: 1,
                                    max: 5,
                                    min: 0
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            }
                        }
                    }
                });
            }
        })
        .catch(error => console.error('Error loading risk data:', error));
    {% endif %}
    
    {% if report_type == 'detailed' %}
    // Load charts for each category
    {% for category in ['liquidity', 'profitability', 'safety', 'efficiency', 'cash_flow'] %}
    fetch('/api/indicator_data?ja_code={{ selected_ja_code }}&year={{ selected_year }}&type={{ category }}')
        .then(response => response.json())
        .then(response => {
            if (response.status === 'success' && document.getElementById('chart{{ category }}')) {
                // Draw chart
                const ctx = document.getElementById('chart{{ category }}').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: response.data.labels,
                        datasets: [
                            {
                                label: '指標値',
                                data: response.data.values,
                                backgroundColor: response.data.colors,
                                borderColor: response.data.colors.map(color => color.replace('0.7', '1')),
                                borderWidth: 1
                            },
                            {
                                label: '基準値',
                                data: response.data.benchmarks,
                                type: 'line',
                                fill: false,
                                borderColor: 'rgba(255, 255, 255, 0.7)',
                                borderDash: [5, 5],
                                pointBackgroundColor: 'rgba(255, 255, 255, 0.7)',
                                pointBorderColor: 'rgba(255, 255, 255, 0.7)'
                            }
                        ]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            }
                        }
                    }
                });
            }
        })
        .catch(error => console.error('Error loading indicator data:', error));
    {% endfor %}
    {% endif %}
});
</script>
{% endblock %}
