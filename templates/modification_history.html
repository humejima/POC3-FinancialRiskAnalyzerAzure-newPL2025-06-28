{% extends "layout.html" %}
{% block title %}ä¿®æ­£å±¥æ­´ç®¡ç†{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>ğŸ”§ ä¿®æ­£å±¥æ­´ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h2>

    <!-- çµ±è¨ˆæƒ…å ± -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">ç·ä¿®æ­£æ•°</h5>
                    <h2 class="text-primary">{{ stats.total }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">ã‚¿ã‚¤ãƒ—åˆ¥</h5>
                    {% for type, count in stats.by_type.items() %}
                    <div class="d-flex justify-content-between">
                        <span>{{ type }}</span>
                        <span class="badge bg-secondary">{{ count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">å½±éŸ¿ãƒ¬ãƒ™ãƒ«åˆ¥</h5>
                    {% for level, count in stats.by_impact.items() %}
                    <div class="d-flex justify-content-between">
                        <span>{{ level }}</span>
                        <span class="badge bg-info">{{ count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- å•é¡Œãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>ğŸ” é¡ä¼¼å•é¡Œãƒã‚§ãƒƒã‚¯</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label for="issueDescription" class="form-label">å•é¡Œã®èª¬æ˜</label>
                <textarea class="form-control" id="issueDescription" rows="3" 
                         placeholder="ç™ºç”Ÿã—ã¦ã„ã‚‹å•é¡Œã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
            </div>
            <div class="mb-3">
                <label for="errorMessages" class="form-label">ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
                <textarea class="form-control" id="errorMessages" rows="2" 
                         placeholder="ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
            </div>
            <button type="button" class="btn btn-primary" onclick="checkSimilarIssue()">
                é¡ä¼¼å•é¡Œã‚’ãƒã‚§ãƒƒã‚¯
            </button>
            <div id="checkResult" class="mt-3"></div>
        </div>
    </div>

    <!-- æœ€æ–°ã®ä¿®æ­£å±¥æ­´ -->
    <div class="card">
        <div class="card-header">
            <h5>ğŸ“‹ æœ€æ–°ã®ä¿®æ­£å±¥æ­´</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>æ—¥æ™‚</th>
                            <th>å•é¡Œã‚¿ã‚¤ãƒ—</th>
                            <th>èª¬æ˜</th>
                            <th>å½±éŸ¿ãƒ¬ãƒ™ãƒ«</th>
                            <th>ãƒ•ã‚¡ã‚¤ãƒ«æ•°</th>
                            <th>è§£æ±ºæ‰‹é †</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in history[-10:] %}
                        <tr>
                            <td>{{ record.timestamp[:19] }}</td>
                            <td>
                                <span class="badge bg-secondary">{{ record.issue_type }}</span>
                            </td>
                            <td>{{ record.description[:50] }}{% if record.description|length > 50 %}...{% endif %}</td>
                            <td>
                                {% set level_class = 'success' if record.impact_level == 'low' else 'warning' if record.impact_level == 'medium' else 'danger' %}
                                <span class="badge bg-{{ level_class }}">{{ record.impact_level }}</span>
                            </td>
                            <td>{{ record.file_paths|length }}</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-info" 
                                        onclick="showDetails('{{ record.id }}')">
                                    è©³ç´°
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ä¿®æ­£è©³ç´°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- è©³ç´°å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
        </div>
    </div>
</div>

<div class="row mb-3">
            <div class="col-md-6">
                <h3>æ–°ã—ã„å•é¡Œã‚’ãƒã‚§ãƒƒã‚¯</h3>
                <form onsubmit="event.preventDefault(); checkSimilarIssue();">
                    <div class="mb-3">
                        <label for="issueDescription" class="form-label">å•é¡Œã®èª¬æ˜</label>
                        <textarea class="form-control" id="issueDescription" rows="3" 
                                placeholder="ç™ºç”Ÿã—ã¦ã„ã‚‹å•é¡Œã‚’èª¬æ˜ã—ã¦ãã ã•ã„"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="errorMessages" class="form-label">ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆ1è¡Œã«1ã¤ï¼‰</label>
                        <textarea class="form-control" id="errorMessages" rows="3" 
                                placeholder="ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">é¡ä¼¼å•é¡Œã‚’ãƒã‚§ãƒƒã‚¯</button>
                </form>
            </div>
            <div class="col-md-6">
                <h3>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç¿»è¨³</h3>
                <form onsubmit="event.preventDefault(); translateMessage();">
                    <div class="mb-3">
                        <label for="originalMessage" class="form-label">è‹±èªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
                        <textarea class="form-control" id="originalMessage" rows="3" 
                                placeholder="è‹±èªã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚„ãƒ­ã‚°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="translatedMessage" class="form-label">æ—¥æœ¬èªç¿»è¨³</label>
                        <textarea class="form-control" id="translatedMessage" rows="3" readonly 
                                placeholder="ç¿»è¨³çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
                    </div>
                    <button type="submit" class="btn btn-success">æ—¥æœ¬èªã«ç¿»è¨³</button>
                </form>
            </div></div>

<script>
async function checkSimilarIssue() {
    const description = document.getElementById('issueDescription').value;
    const errorMessages = document.getElementById('errorMessages').value.split('\n').filter(msg => msg.trim());

    if (!description.trim()) {
        alert('å•é¡Œã®èª¬æ˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }

    try {
        const response = await fetch('/check_similar_issue', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                description: description,
                error_messages: errorMessages
            })
        });

        const result = await response.json();
        const resultDiv = document.getElementById('checkResult');

        if (result.similar_modifications && result.similar_modifications.length > 0) {
            let html = '<div class="alert alert-warning">';
            html += '<h6>âš ï¸ é¡ä¼¼ã®å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:</h6>';

            result.similar_modifications.slice(0, 3).forEach(mod => {
                html += `<div class="border p-2 mb-2">`;
                html += `<strong>${mod.description}</strong> (é¡ä¼¼åº¦: ${(mod.similarity_score * 100).toFixed(1)}%)<br>`;
                html += `<small>è§£æ±ºæ‰‹é †:</small><ul>`;
                mod.solution_steps.slice(0, 3).forEach(step => {
                    html += `<li>${step}</li>`;
                });
                html += `</ul></div>`;
            });

            html += '</div>';
            resultDiv.innerHTML = html;
        } else {
            resultDiv.innerHTML = '<div class="alert alert-success">âœ… é¡ä¼¼ã®å•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ–°ã—ã„å•é¡Œã§ã™ã€‚</div>';
        }
    } catch (error) {
        document.getElementById('checkResult').innerHTML = 
            `<div class="alert alert-danger">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
    }
}

function showDetails(recordId) {
    const record = {{ history|tojsonfilter|safe }}.find(r => r.id === recordId);
    if (!record) return;

    let html = `
        <h6>å•é¡Œã‚¿ã‚¤ãƒ—: ${record.issue_type}</h6>
        <p><strong>èª¬æ˜:</strong> ${record.description}</p>
        <p><strong>å½±éŸ¿ãƒ¬ãƒ™ãƒ«:</strong> ${record.impact_level}</p>

        <h6>é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«:</h6>
        <ul>
            ${record.file_paths.map(path => `<li>${path}</li>`).join('')}
        </ul>

        <h6>è§£æ±ºæ‰‹é †:</h6>
        <ol>
            ${record.solution_steps.map(step => `<li>${step}</li>`).join('')}
        </ol>

        ${record.error_messages.length > 0 ? `
        <h6>ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</h6>
        <pre class="bg-light p-2">${record.error_messages.join('\n')}</pre>
        ` : ''}

        ${record.tags.length > 0 ? `
        <h6>ã‚¿ã‚°:</h6>
        <p>${record.tags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('')}</p>
        ` : ''}
    `;

    document.getElementById('modalBody').innerHTML = html;
    new bootstrap.Modal(document.getElementById('detailModal')).show();
}

async function translateMessage() {
    const originalMessage = document.getElementById('originalMessage').value;

    if (!originalMessage.trim()) {
        alert('ç¿»è¨³ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }

    try {
        const response = await fetch('/translate_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: originalMessage
            })
        });

        const result = await response.json();

        if (result.success) {
            document.getElementById('translatedMessage').value = result.translated;

            // ç¿»è¨³çµæœã‚’è¡¨ç¤º
            const resultDiv = document.getElementById('translationResult');
            if (resultDiv) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>ç¿»è¨³å®Œäº†:</strong><br>
                        <strong>åŸæ–‡:</strong> ${result.original}<br>
                        <strong>ç¿»è¨³:</strong> ${result.translated}
                    </div>
                `;
            }
        } else {
            alert('ç¿»è¨³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
        }
    } catch (error) {
        console.error('Translation error:', error);
        alert('ç¿»è¨³å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
}
</script>
{% endblock %}