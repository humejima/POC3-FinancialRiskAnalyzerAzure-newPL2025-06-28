{% extends "layout.html" %}
{% block title %}修正履歴管理{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>🔧 修正履歴管理システム</h2>

    <!-- 統計情報 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">総修正数</h5>
                    <h2 class="text-primary">{{ stats.total }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">タイプ別</h5>
                    {% for type, count in stats.by_type.items() %}
                    <div class="d-flex justify-content-between">
                        <span>{{ type }}</span>
                        <span class="badge bg-secondary">{{ count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">影響レベル別</h5>
                    {% for level, count in stats.by_impact.items() %}
                    <div class="d-flex justify-content-between">
                        <span>{{ level }}</span>
                        <span class="badge bg-info">{{ count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- 問題チェック機能 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>🔍 類似問題チェック</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label for="issueDescription" class="form-label">問題の説明</label>
                <textarea class="form-control" id="issueDescription" rows="3" 
                         placeholder="発生している問題を入力してください"></textarea>
            </div>
            <div class="mb-3">
                <label for="errorMessages" class="form-label">エラーメッセージ</label>
                <textarea class="form-control" id="errorMessages" rows="2" 
                         placeholder="エラーメッセージがあれば入力してください"></textarea>
            </div>
            <button type="button" class="btn btn-primary" onclick="checkSimilarIssue()">
                類似問題をチェック
            </button>
            <div id="checkResult" class="mt-3"></div>
        </div>
    </div>

    <!-- 最新の修正履歴 -->
    <div class="card">
        <div class="card-header">
            <h5>📋 最新の修正履歴</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>日時</th>
                            <th>問題タイプ</th>
                            <th>説明</th>
                            <th>影響レベル</th>
                            <th>ファイル数</th>
                            <th>解決手順</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in history[-10:] %}
                        <tr>
                            <td>{{ record.timestamp[:19] }}</td>
                            <td>
                                <span class="badge bg-secondary">{{ record.issue_type }}</span>
                            </td>
                            <td>{{ record.description[:50] }}{% if record.description|length > 50 %}...{% endif %}</td>
                            <td>
                                {% set level_class = 'success' if record.impact_level == 'low' else 'warning' if record.impact_level == 'medium' else 'danger' %}
                                <span class="badge bg-{{ level_class }}">{{ record.impact_level }}</span>
                            </td>
                            <td>{{ record.file_paths|length }}</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-info" 
                                        onclick="showDetails('{{ record.id }}')">
                                    詳細
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 詳細モーダル -->
<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">修正詳細</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- 詳細内容がここに表示される -->
            </div>
        </div>
    </div>
</div>

<div class="row mb-3">
            <div class="col-md-6">
                <h3>新しい問題をチェック</h3>
                <form onsubmit="event.preventDefault(); checkSimilarIssue();">
                    <div class="mb-3">
                        <label for="issueDescription" class="form-label">問題の説明</label>
                        <textarea class="form-control" id="issueDescription" rows="3" 
                                placeholder="発生している問題を説明してください"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="errorMessages" class="form-label">エラーメッセージ（1行に1つ）</label>
                        <textarea class="form-control" id="errorMessages" rows="3" 
                                placeholder="エラーメッセージがあれば入力してください"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">類似問題をチェック</button>
                </form>
            </div>
            <div class="col-md-6">
                <h3>メッセージ翻訳</h3>
                <form onsubmit="event.preventDefault(); translateMessage();">
                    <div class="mb-3">
                        <label for="originalMessage" class="form-label">英語メッセージ</label>
                        <textarea class="form-control" id="originalMessage" rows="3" 
                                placeholder="英語のエラーメッセージやログを入力してください"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="translatedMessage" class="form-label">日本語翻訳</label>
                        <textarea class="form-control" id="translatedMessage" rows="3" readonly 
                                placeholder="翻訳結果がここに表示されます"></textarea>
                    </div>
                    <button type="submit" class="btn btn-success">日本語に翻訳</button>
                </form>
            </div></div>

<script>
async function checkSimilarIssue() {
    const description = document.getElementById('issueDescription').value;
    const errorMessages = document.getElementById('errorMessages').value.split('\n').filter(msg => msg.trim());

    if (!description.trim()) {
        alert('問題の説明を入力してください');
        return;
    }

    try {
        const response = await fetch('/check_similar_issue', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                description: description,
                error_messages: errorMessages
            })
        });

        const result = await response.json();
        const resultDiv = document.getElementById('checkResult');

        if (result.similar_modifications && result.similar_modifications.length > 0) {
            let html = '<div class="alert alert-warning">';
            html += '<h6>⚠️ 類似の問題が見つかりました:</h6>';

            result.similar_modifications.slice(0, 3).forEach(mod => {
                html += `<div class="border p-2 mb-2">`;
                html += `<strong>${mod.description}</strong> (類似度: ${(mod.similarity_score * 100).toFixed(1)}%)<br>`;
                html += `<small>解決手順:</small><ul>`;
                mod.solution_steps.slice(0, 3).forEach(step => {
                    html += `<li>${step}</li>`;
                });
                html += `</ul></div>`;
            });

            html += '</div>';
            resultDiv.innerHTML = html;
        } else {
            resultDiv.innerHTML = '<div class="alert alert-success">✅ 類似の問題は見つかりませんでした。新しい問題です。</div>';
        }
    } catch (error) {
        document.getElementById('checkResult').innerHTML = 
            `<div class="alert alert-danger">エラー: ${error.message}</div>`;
    }
}

function showDetails(recordId) {
    const record = {{ history|tojsonfilter|safe }}.find(r => r.id === recordId);
    if (!record) return;

    let html = `
        <h6>問題タイプ: ${record.issue_type}</h6>
        <p><strong>説明:</strong> ${record.description}</p>
        <p><strong>影響レベル:</strong> ${record.impact_level}</p>

        <h6>関連ファイル:</h6>
        <ul>
            ${record.file_paths.map(path => `<li>${path}</li>`).join('')}
        </ul>

        <h6>解決手順:</h6>
        <ol>
            ${record.solution_steps.map(step => `<li>${step}</li>`).join('')}
        </ol>

        ${record.error_messages.length > 0 ? `
        <h6>エラーメッセージ:</h6>
        <pre class="bg-light p-2">${record.error_messages.join('\n')}</pre>
        ` : ''}

        ${record.tags.length > 0 ? `
        <h6>タグ:</h6>
        <p>${record.tags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('')}</p>
        ` : ''}
    `;

    document.getElementById('modalBody').innerHTML = html;
    new bootstrap.Modal(document.getElementById('detailModal')).show();
}

async function translateMessage() {
    const originalMessage = document.getElementById('originalMessage').value;

    if (!originalMessage.trim()) {
        alert('翻訳するメッセージを入力してください');
        return;
    }

    try {
        const response = await fetch('/translate_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: originalMessage
            })
        });

        const result = await response.json();

        if (result.success) {
            document.getElementById('translatedMessage').value = result.translated;

            // 翻訳結果を表示
            const resultDiv = document.getElementById('translationResult');
            if (resultDiv) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>翻訳完了:</strong><br>
                        <strong>原文:</strong> ${result.original}<br>
                        <strong>翻訳:</strong> ${result.translated}
                    </div>
                `;
            }
        } else {
            alert('翻訳に失敗しました: ' + result.message);
        }
    } catch (error) {
        console.error('Translation error:', error);
        alert('翻訳処理でエラーが発生しました');
    }
}
</script>
{% endblock %}